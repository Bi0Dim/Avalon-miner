# Архитектура Quaxis Solo Miner

## Обзор системы

Universal AuxPoW Core - автономная система для соло-майнинга Bitcoin, 
оптимизированная для минимальной латентности. Работает без внешнего Bitcoin Core.

```
┌──────────────────────────────────────────────────────────────────────┐
│                         BITCOIN NETWORK                               │
└────────────────────────────────┬─────────────────────────────────────┘
                                 │ P2P / FIBRE
                                 ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    UNIVERSAL AUXPOW CORE (Self-Contained)            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │
│  │  Headers Sync   │  │  Template       │  │  MTP Calculator     │  │
│  │  (P2P/FIBRE)    │──│  Generator      │──│  (last 11 blocks)   │  │
│  └─────────────────┘  └────────┬────────┘  └─────────────────────┘  │
│                                │                                      │
│  ┌─────────────────┐  ┌────────▼────────┐  ┌─────────────────────┐  │
│  │  PoW Validator  │  │  Job Manager    │  │  Template Cache     │  │
│  │                 │──│  (extranonce)   │──│  (precompute N+1)   │  │
│  └─────────────────┘  └────────┬────────┘  └─────────────────────┘  │
│                                │                                      │
│  ┌─────────────────┐  ┌────────▼────────┐  ┌─────────────────────┐  │
│  │  Coinbase       │  │  Share          │  │  Status Reporter    │  │
│  │  Builder        │──│  Validator      │──│  (terminal output)  │  │
│  │  (+midstate)    │  │                 │  │                     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │
│                                │                                      │
│  ┌─────────────────────────────▼──────────────────────────────────┐  │
│  │                      TCP SERVER (port 3333)                     │  │
│  │              Бинарный протокол 48 байт / 8 байт                 │  │
│  └──────────────────────────────┬─────────────────────────────────┘  │
└─────────────────────────────────┼────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      AVALON 1126 PRO (114 чипов)                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │
│  │  Network Client │──│  SPI Controller │──│  A1126 ASIC Chips   │  │
│  │  (TCP)          │  │                 │  │  (SHA256 x 114)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │
└──────────────────────────────────────────────────────────────────────┘
```

## Компоненты

### 1. Universal AuxPoW Core (Self-Contained)

Автономное ядро, работающее без внешнего Bitcoin Core:

- **Headers Sync**: Синхронизация заголовков через P2P/FIBRE
- **Template Generator**: Внутренняя генерация шаблонов блоков
- **MTP Calculator**: Вычисление Median Time Past
- **PoW Validator**: Проверка Proof-of-Work

### 2. Quaxis Solo Miner Server

C++23 сервер, координирующий майнинг:

| Модуль | Функция |
|--------|---------|
| Headers Sync | Синхронизация заголовков через P2P/FIBRE |
| Template Generator | Генерация шаблонов блоков |
| Job Manager | Генерация заданий с midstate |
| Template Cache | Предвычисление шаблона N+1 |
| Coinbase Builder | Создание coinbase с тегом "quaxis" |
| Share Validator | Проверка nonce от ASIC |
| TCP Server | Связь с ASIC по бинарному протоколу |
| Status Reporter | Терминальный вывод статуса |

### 3. Прошивка ASIC

Минимальная прошивка для Avalon 1126 Pro:

- Бинарный протокол (48/8 байт)
- Получение готового midstate
- SPI управление 114 чипами
- Минимальная логика

## Поток данных

### Получение нового блока

```
1. Headers Sync получает headers от P2P/FIBRE сети
2. Template Generator создаёт новый шаблон блока
3. Вычисление MTP+1 для timestamp
4. Создание coinbase + вычисление midstate
5. Генерация задания (48 байт)
6. Отправка на ASIC по TCP
7. ASIC загружает midstate в чипы
8. Начало перебора nonce
```

### Нахождение блока

```
1. ASIC находит nonce, удовлетворяющий target
2. Отправка share (8 байт) на сервер
3. Server валидирует share
4. Сборка полного блока
5. Рассылка блока в P2P сеть
```

## Оптимизации

### Время реакции на новый блок

| Этап | Stratum | Quaxis | Экономия |
|------|---------|--------|----------|
| ZMQ уведомление | 1-3 мс | — | — |
| Shared Memory | — | 100 нс | ~1-3 мс |
| JSON парсинг | 1-5 мс | — | — |
| Бинарный протокол | — | 1 мкс | ~1-5 мс |
| Передача задания | 500-1000 байт | 48 байт | 10x меньше |
| **Spy Mining** | 150-1500 мс | 0 мс | 150-1500 мс |

### Вычислительные оптимизации

- **Midstate**: ASIC делает 1 SHA256 вместо 2 (+3.3%)
- **Пустые блоки**: Только coinbase, нет merkle tree
- **SHA-NI**: Аппаратное ускорение на сервере
- **Предвычисление**: Coinbase midstate кешируется

## Требования к железу

### Сервер

- CPU: Intel/AMD с SHA-NI (Zen+, Ice Lake+)
- RAM: 4+ GB
- SSD: Для хранения данных
- Сеть: 1 Gbps

### ASIC

- Avalon 1126 Pro (90+ TH/s)
- Ethernet подключение
- Стабильное питание
