# Архитектура Quaxis Solo Miner

## Обзор системы

Quaxis Solo Miner - однопроцессорная система для соло-майнинга Bitcoin, 
оптимизированная для минимальной латентности.

```
┌──────────────────────────────────────────────────────────────────────┐
│                         BITCOIN NETWORK                               │
└────────────────────────────────┬─────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      МОДИФИЦИРОВАННЫЙ BITCOIN CORE                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │
│  │  Validation     │  │  Spy Mining     │  │  Shared Memory      │  │
│  │                 │──│  Callback       │──│  Bridge             │  │
│  │  (+ priority)   │  │                 │  │  /quaxis_block      │  │
│  └─────────────────┘  └─────────────────┘  └──────────┬──────────┘  │
└───────────────────────────────────────────────────────┼──────────────┘
                                                        │ ~100 нс
                                                        ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      QUAXIS SOLO MINER SERVER                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │
│  │  SHM Subscriber │  │  Job Manager    │  │  Template Cache     │  │
│  │  (spin-wait)    │──│  (extranonce)   │──│  (precompute N+1)   │  │
│  └─────────────────┘  └────────┬────────┘  └─────────────────────┘  │
│                                │                                      │
│  ┌─────────────────┐  ┌────────▼────────┐  ┌─────────────────────┐  │
│  │  Coinbase       │  │  Share          │  │  Stats Collector    │  │
│  │  Builder        │──│  Validator      │──│                     │  │
│  │  (+midstate)    │  │                 │  │                     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │
│                                │                                      │
│  ┌─────────────────────────────▼──────────────────────────────────┐  │
│  │                      TCP SERVER (port 3333)                     │  │
│  │              Бинарный протокол 48 байт / 8 байт                 │  │
│  └──────────────────────────────┬─────────────────────────────────┘  │
└─────────────────────────────────┼────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      AVALON 1126 PRO (114 чипов)                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │
│  │  Network Client │──│  SPI Controller │──│  A1126 ASIC Chips   │  │
│  │  (TCP)          │  │                 │  │  (SHA256 x 114)     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────┘  │
└──────────────────────────────────────────────────────────────────────┘
```

## Компоненты

### 1. Модифицированный Bitcoin Core

Стандартный Bitcoin Core с патчами:

- **Shared Memory Bridge**: POSIX shm для уведомлений (~100 нс латентность)
- **Spy Mining Callback**: Уведомление ДО полной валидации блока
- **Block Priority**: Приоритет block сообщений в очереди

### 2. Quaxis Solo Miner Server

C++23 сервер, координирующий майнинг:

| Модуль | Функция |
|--------|---------|
| SHM Subscriber | Получение блоков через shared memory |
| Job Manager | Генерация заданий с midstate |
| Template Cache | Предвычисление шаблона N+1 |
| Coinbase Builder | Создание coinbase с тегом "quaxis" |
| Share Validator | Проверка nonce от ASIC |
| TCP Server | Связь с ASIC по бинарному протоколу |
| Stats Collector | Мониторинг и статистика |

### 3. Прошивка ASIC

Минимальная прошивка для Avalon 1126 Pro:

- Бинарный протокол (48/8 байт)
- Получение готового midstate
- SPI управление 114 чипами
- Минимальная логика

## Поток данных

### Получение нового блока

```
1. Bitcoin Core получает block/headers от сети
2. Quick PoW check (spy mining)
3. Запись в Shared Memory (/quaxis_block)
4. Quaxis Server детектирует изменение sequence
5. Создание coinbase + вычисление midstate
6. Генерация задания (48 байт)
7. Отправка на ASIC по TCP
8. ASIC загружает midstate в чипы
9. Начало перебора nonce
```

### Нахождение блока

```
1. ASIC находит nonce, удовлетворяющий target
2. Отправка share (8 байт) на сервер
3. Server валидирует share
4. Сборка полного блока
5. submitblock через RPC в Bitcoin Core
6. Bitcoin Core рассылает блок в сеть
```

## Оптимизации

### Время реакции на новый блок

| Этап | Stratum | Quaxis | Экономия |
|------|---------|--------|----------|
| ZMQ уведомление | 1-3 мс | — | — |
| Shared Memory | — | 100 нс | ~1-3 мс |
| JSON парсинг | 1-5 мс | — | — |
| Бинарный протокол | — | 1 мкс | ~1-5 мс |
| Передача задания | 500-1000 байт | 48 байт | 10x меньше |
| **Spy Mining** | 150-1500 мс | 0 мс | 150-1500 мс |

### Вычислительные оптимизации

- **Midstate**: ASIC делает 1 SHA256 вместо 2 (+3.3%)
- **Пустые блоки**: Только coinbase, нет merkle tree
- **SHA-NI**: Аппаратное ускорение на сервере
- **Предвычисление**: Coinbase midstate кешируется

## Требования к железу

### Сервер

- CPU: Intel/AMD с SHA-NI (Zen+, Ice Lake+)
- RAM: 4+ GB
- SSD: Для Bitcoin Core
- Сеть: 1 Gbps

### ASIC

- Avalon 1126 Pro (90+ TH/s)
- Ethernet подключение
- Стабильное питание
