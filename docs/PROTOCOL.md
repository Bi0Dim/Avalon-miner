# Спецификация бинарного протокола Quaxis

## Обзор

Бинарный протокол для связи между Quaxis Server и ASIC Avalon 1126 Pro.
Оптимизирован для минимальной латентности и размера пакетов.

## Сравнение с Stratum

| Параметр | Stratum v1 | Quaxis |
|----------|------------|--------|
| Формат | JSON | Бинарный |
| Размер задания | 500-1000 байт | 48 байт |
| Размер ответа | 200-300 байт | 8 байт |
| Парсинг | Необходим | Не нужен |
| Латентность | 1-5 мс | <1 мкс |

## Структуры данных

### Задание (Server → ASIC)

Размер: 48 байт

```
Смещение  Размер  Поле          Описание
---------------------------------------------------------
0         32      midstate      SHA256 midstate первых 64 байт header
32        12      header_tail   Последние 12 байт header (timestamp, bits, merkle_part)
44        4       job_id        Идентификатор задания (Little-Endian)
---------------------------------------------------------
Итого:    48      байт
```

#### Детали midstate

Midstate - это промежуточное состояние SHA256 после обработки первых 64 байт
заголовка блока. Содержит 8 x 32-bit слов (H0-H7).

```cpp
struct Midstate {
    uint32_t h[8];  // H0, H1, H2, H3, H4, H5, H6, H7
};
```

#### Детали header_tail

Последние 12 байт заголовка блока:

```
Смещение  Размер  Поле          Описание
---------------------------------------------------------
0         4       timestamp     Время в Unix timestamp (LE)
4         4       bits          Сложность в compact формате (LE)
8         4       merkle_part   Часть merkle root (для валидации)
---------------------------------------------------------
```

### Ответ (ASIC → Server)

Размер: 8 байт

```
Смещение  Размер  Поле          Описание
---------------------------------------------------------
0         4       job_id        Идентификатор задания (LE)
4         4       nonce         Найденный nonce (LE)
---------------------------------------------------------
Итого:    8       байт
```

## Сообщения протокола

### JOB (0x01) - Новое задание

**Направление**: Server → ASIC

**Структура пакета**:
```
[1 байт: тип=0x01] [48 байт: данные задания]
```

**Поведение ASIC**:
1. Остановить текущий перебор
2. Загрузить новый midstate в чипы
3. Начать перебор nonce от 0

### SHARE (0x02) - Найденный nonce

**Направление**: ASIC → Server

**Структура пакета**:
```
[1 байт: тип=0x02] [8 байт: job_id + nonce]
```

**Поведение Server**:
1. Проверить, что job_id ещё активен
2. Реконструировать полный header
3. Вычислить SHA256d(header)
4. Проверить hash <= target
5. Если валидно - submitblock

### PING (0x03) - Проверка связи

**Направление**: Двунаправленное

**Структура пакета**:
```
[1 байт: тип=0x03] [8 байт: timestamp]
```

**Использование**:
- Каждые 30 секунд для проверки связи
- Расчёт RTT

### STATUS (0x04) - Статус ASIC

**Направление**: ASIC → Server

**Структура пакета**:
```
[1 байт: тип=0x04] [16 байт: данные статуса]
```

**Данные статуса**:
```
Смещение  Размер  Поле          Описание
---------------------------------------------------------
0         8       hashrate      Хешрейт в H/s (LE)
8         2       temp_chip     Температура чипов (°C × 10)
10        2       temp_board    Температура платы (°C × 10)
12        2       fan_speed     Скорость вентилятора (RPM)
14        2       errors        Счётчик ошибок
---------------------------------------------------------
```

## Порядок байтов

Все многобайтовые значения в **Little-Endian** (LE).

```cpp
// Пример преобразования
uint32_t value = 0x12345678;
uint8_t bytes[4];
bytes[0] = value & 0xFF;         // 0x78
bytes[1] = (value >> 8) & 0xFF;  // 0x56
bytes[2] = (value >> 16) & 0xFF; // 0x34
bytes[3] = (value >> 24) & 0xFF; // 0x12
```

## Машина состояний

### Состояние соединения

```
┌────────────────┐
│  DISCONNECTED  │
└───────┬────────┘
        │ connect()
        ▼
┌────────────────┐
│  CONNECTING    │
└───────┬────────┘
        │ TCP connected
        ▼
┌────────────────┐
│  IDLE          │◄──────────────────┐
└───────┬────────┘                   │
        │ recv JOB                   │
        ▼                            │
┌────────────────┐                   │
│  MINING        │───────────────────┤
└───────┬────────┘  recv JOB (new)   │
        │                            │
        │ find nonce                 │
        ▼                            │
┌────────────────┐                   │
│  SUBMITTING    │───────────────────┘
└────────────────┘  send SHARE
```

## Обработка ошибок

### Таймауты

| Событие | Таймаут | Действие |
|---------|---------|----------|
| Нет JOB | 60 сек | Reconnect |
| Нет PONG | 30 сек | Reconnect |
| TCP send | 5 сек | Reconnect |

### Коды ошибок

| Код | Описание |
|-----|----------|
| 0x00 | Успех |
| 0x01 | Неизвестный job_id |
| 0x02 | Stale share |
| 0x03 | Дубликат nonce |
| 0x04 | Низкая сложность |

## Пример сессии

```
# Установка соединения
ASIC → Server: [TCP connect]
Server → ASIC: [TCP accept]

# Первое задание
Server → ASIC: 01 [48 байт midstate+header_tail+job_id]

# ASIC майнит, находит nonce
ASIC → Server: 02 [job_id=1] [nonce=0x12345678]

# Сервер подтверждает
# (неявно, отправляя новое задание)

# Новый блок в сети
Server → ASIC: 01 [48 байт новое задание, job_id=2]

# Периодический ping
Server → ASIC: 03 [timestamp]
ASIC → Server: 03 [timestamp]

# Статус ASIC
ASIC → Server: 04 [hashrate] [temp_chip] [temp_board] [fan] [errors]
```

## Совместимость

Протокол версионируется первым байтом. Текущая версия: 0x01.

Для будущей совместимости зарезервированы типы сообщений 0xF0-0xFF.
